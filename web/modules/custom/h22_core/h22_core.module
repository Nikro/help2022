<?php

/**
 * @file
 * Contains h22_core.module.
 */

use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Language\LanguageInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\node\Entity\NodeType;
use http\Url;

/**
 * Implements hook_help().
 */
function h22_core_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the h22_core module.
    case 'help.page.h22_core':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Core module, required by the project.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_theme().
 */
function h22_core_theme() {
  return [
    'h22_core_homepage' => [
      'render element' => 'children',
    ],
  ];
}

/**
 * Implements hook_form_alter().
 */
function h22_core_form_node_host_location_edit_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  _h22_core_adjust_edit_or_add_for($form, $form_state, $form_id);
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function h22_core_form_node_host_location_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  _h22_core_adjust_edit_or_add_for($form, $form_state, $form_id);
}

function h22_core_form_user_login_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['captcha']['#weight'] = $form['actions']['#weight'] - 1;
  $form['#submit'][] = 'h22_core_user_login_redirect_form_submit';
}

/**
 * Custom submit handler for the login form.
 */
function h22_core_user_login_redirect_form_submit($form, FormStateInterface $form_state) {
  $form_state->setRedirect('view.dashboards.page_locations');
}

/**
 * That's where we implement our changes.
 */
function _h22_core_adjust_edit_or_add_for(&$form, FormStateInterface $form_state, $form_id) {
  // Get only configurable languages in content language selector.
  $new_language_options = [];
  $languages = \Drupal::languageManager()->getLanguages();
  foreach ($languages as $langcode => $language) {
    /** @var \Drupal\Core\StringTranslation\TranslatableMarkup $language */
    $new_language_options[$langcode] = $language->getName();
  }
  $form["langcode"]["widget"][0]["value"]["#options"] = $new_language_options;

  // Hide author options if authenticated user.
  $current_user = \Drupal::currentUser();
  $user_roles = $current_user->getRoles();
  if (in_array('authenticated', $user_roles) && !in_array('administrator', $user_roles)) {
    $form['revision_log']['#access'] = FALSE;
    $form['meta']['#access'] = FALSE;
    $form['meta']['published']['#access'] = FALSE;
    $form['meta']['changed']['#access'] = FALSE;
    $form['meta']['author']['#access'] = FALSE;
    if ($form["revision"]["#type"] == 'checkbox') {
      $form["revision"]["#access"] = FALSE;
    }
  }

  // Conditional field.
  $form['field_organization_name']['#states']['visible'] = [
    ':input[name="field_type"]' => ['value' => 'organization']
  ];

  // Add HTML help text field.
  $form['meta']['host_location_help'] = [
    '#type' => 'item',
    '#markup' => t('If you are willing and capable to host refugees, please submit your details so refugees can contact you.'),
    '#wrapper_attributes' => ['class' => ['host_location_help']],
    '#weight' => '0',
  ];

  $form['meta']['host_location_warning'] = [
    '#type' => 'inline_template',
    '#template' =>
      "<div class='host_location_warning'>
    {{ 'As it is now wartime, please be wary of sabotage and Russian hacks.'|t }}<br>
    {{ 'We are taking all the safety measures to protect your data and your identity.'|t }}<br><br>

    {{ 'To help us take these measures:'|t }}<br>
    <ul>
        <li>{{ 'Do not share your precise home address.'|t }}</li>
        <li>{{ 'Talk to the person before accepting to host.'|t }}</li>
    </ul>

    {{ 'Follow the general safety measures to assure your and refugees safety.'|t }}
    </div>",
    '#weight' => '0',
  ];
}


/**
 * Implements hook_entity_extra_field_info().
 */
function h22_core_entity_extra_field_info() {
  $extra = array();

  $extra['node']['host_location']['display']['view_contacts_info'] = array(
    'label' => t('View GetContact Form'),
    'description' => t('Pseudo-field that renders a button'),
    'weight' => 100,
    'visible' => TRUE,
  );

  return $extra;
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function h22_core_node_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {
  if ($display->getComponent('view_contacts_info')) {
    $form = \Drupal::formBuilder()->getForm('Drupal\h22_core\Form\ViewContactInformation', $entity);
    $build['form'] = $form;
    $build['form']['#weight'] = 9;
  }
}
